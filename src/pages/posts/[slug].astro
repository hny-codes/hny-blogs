---
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';
import { contentfulClient } from '../../lib/contentful';
import BaseLayout from '../../layouts/BaseLayout.astro';
import type { BlogPost } from '../../lib/contentful';
import { BLOCKS } from '@contentful/rich-text-types';

export async function getStaticPaths() {
  // REFERENCE: https://www.contentful.com/blog/rendering-linked-assets-entries-in-contentful/
  const renderOptions = {
    renderNode: {
      [BLOCKS.EMBEDDED_ASSET]: (node: any) =>
        `<img src=https:${node.data.target.fields.file.url} 
        height=${node.data.target.fields.file.details.image.height} 
        width=${node.data.target.fields.file.details.image.width} 
        alt=${node.data.target.fields.description} />`,
      [BLOCKS.HEADING_1]: (node: any) =>
        `<h1 class='font-bold text-3xl'>
          ${node.content[0].value}
        </h1>`,
      [BLOCKS.HEADING_2]: (node: any) =>
        `<h2 class='font-bold text-2xl'>
            ${node.content[0].value}
        </h2>`,
    },
  };

  // @ts-ignore
  const entries = await contentfulClient.getEntries<BlogPost>({
    content_type: 'blogPost',
  });

  // console.log(JSON.stringify(entries.items));

  const pages = entries.items.map((item) => ({
    // @ts-ignore
    params: { slug: item.fields.slug },
    props: {
      // @ts-ignore
      title: item.fields.title,
      // @ts-ignore
      content: documentToHtmlString(item.fields.content, renderOptions),
      // @ts-ignore
      date: new Date(item.fields.date).toLocaleDateString(),
    },
  }));

  return pages;
}

const { content, title, date } = Astro.props;
---

<BaseLayout pageTitle={title}>
  <div class='my-20 max-w-xl mx-auto px-6 sm:px-2'>
    <div class='mb-10'>
      <h1 class='font-bold text-3xl sm:text-4xl'>{title}</h1>
      <time class='font-semibold'>{date}</time>
    </div>
    <article class='' set:html={content} />
  </div>
</BaseLayout>
